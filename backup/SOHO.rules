#!/bin/bash
# Iptables script for a basic SOHO firewall
# please verify if the Source Address Verification in /
etc/sysctl.conf is enabled:
net.ipv4.conf.all.rp_filter = 1
# Define some variables
# Location of the binaries
IPTABLES="/sbin/iptables"
# Loopback Interface
LOOPBACK="lo"
# External Interface
EXTERNAL= $1
# EXTERNAL_IP will be defined by the WAN Network (dhcp)
# Internal Interface
INTERNAL=$2
INTERNAL_IP=$3
# Remote client
REMOTE_IP="192.168.1.1"
# DNS Server
DNS_IP="192.168.1.1"
# Internal services ports
SSH_PORT="22"
# Flush all rules
$IPTABLES -F
# Set default policies
$IPTABLES -P INPUT DROP
$IPTABLES -P OUTPUT DROP
$IPTABLES -P FORWARD DROP
# Allow access to the Loopback host
$IPTABLES -A INPUT -i $LOOPBACK -j ACCEPT
$IPTABLES -A OUTPUT -o $LOOPBACK -j ACCEPT
# ========================================
# Incoming external traffic rules
# refine it with netstat, tcpdump, syslog, etc.
# Accept ICMP echo-replay incoming traffic for outgoing PINGs
$IPTABLES -A INPUT -i $EXTERNAL -p icmp --icmp-type echoreply -j ACCEPT
# Accept DNS responses for host resolution
$IPTABLES -A INPUT -i $EXTERNAL -p udp -s $DNS_IP --sport domain -j ACCEPT
# Accept all established incoming traffic
$IPTABLES -A INPUT -i $EXTERNAL -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT
# Accept incoming SSH traffic only from well known remote host
$IPTABLES -A INPUT -i $EXTERNAL -p tcp --dport $SSH_PORT -j ACCEPT
# Log all dropped incoming traffic
$IPTABLES -A INPUT -i $EXTERNAL -j LOG --log-prefix="BAD_INPUT:"
# ========================================
# Outgoing external traffic rules
# refine it with netstat, tcpdump, syslog, etc.
# Block ICMP Port Unreachable
$IPTABLES -A OUTPUT -o $EXTERNAL -p icmp -j DROP
# Accept DNS responses for host resolution
$IPTABLES -A OUTPUT -o $EXTERNAL -p udp -d $DNS_IP --dport domain -j ACCEPT
# Block ICMP Port Unreachable
#$IPTABLES -A OUTPUT -o $EXTERNAL -p udp -j DROP
# Accept all outgoing traffic
$IPTABLES -A OUTPUT -o $EXTERNAL -p tcp -j ACCEPT
# Log all dropped outgoing traffic
$IPTABLES -A OUTPUT -o $EXTERNAL -j LOG --log-prefix="BAD_OUTPUT:"
# Internal traffic rules
# Accept all internal input traffic
$IPTABLES -A INPUT -i $INTERNAL -j ACCEPT
# Accept all internal output traffic
$IPTABLES -A OUTPUT -o $INTERNAL -j ACCEPT
# ========================================
# Forwarding packets rules
# Log all dropped incoming forward traffic
$IPTABLES -A FORWARD -i $EXTERNAL -o $INTERNAL -j LOG --logprefix="BAD_INPUT_FORWARD:"
# Log all dropped outgoing forward traffic
$IPTABLES -A FORWARD -i $INTERNAL -o $EXTERNAL -j LOG --logprefix=" BAD_OUTPUT_FORWARD:"

